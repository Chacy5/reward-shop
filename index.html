<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Talk to my paw</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --main-color: #6fedd1;
      --accent-color: #b2fff0;
      --text-dark: #065f54;
      --bg-light: #eafff8;
      --color-daily: #b2fff0;
      --color-weekly: #fff4c3;
      --color-event: #ffe1fa;
      --card-bg: #f0fffa;
      --nav-height: 70px;
      --radius: 14px;
      --shadow: 0 3px 10px 0 #0001;
      --transition: .2s;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100vw;
      min-height: 100vh;
      background: var(--bg-light);
      color: var(--text-dark);
      font-family: 'Montserrat Alternates', sans-serif;
      overflow-x: hidden;
    }
    body {
      min-height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    header {
      width: 100vw;
      background: var(--main-color);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-sizing: border-box;
      border-bottom: 2px solid #57e1c0;
      min-height: 60px;
    }
    .logo-wrap { display: flex; align-items: center; }
    .logo-img, .icon-size {
      width: 40px;
      height: 40px;
      object-fit: contain;
      border-radius: 8px;
      background: #fff;
      box-shadow: var(--shadow);
      margin-right: 8px;
    }
    .logo-img { background: transparent; box-shadow: none; }
    #paw-balance {
      font-size: 1.2em;
      flex: 1 1 auto;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .paw-balance-text {
      font-size: 1.2em;
      font-weight: 600;
      background: #eafff8;
      border-radius: 12px;
      padding: 0.2em 0.9em;
      border: 2px solid #b2fff0;
      color: var(--text-dark);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    #user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
    }
    #show-login-btn, #signout-btn {
      background: transparent;
      border: none;
      border-radius: 8px;
      font-size: 1.3em;
      padding: 2px 8px 2px 2px;
      font-weight: 700;
      cursor: pointer;
      color: var(--main-color);
      transition: color 0.15s;
    }
    #show-login-btn:hover, #signout-btn:hover { color: #025a4a; }
    #user-profile {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #user-name {
      font-weight: 600;
      font-size: 1.05em;
    }
    main {
      flex: 1 1 auto;
      width: 100vw;
      max-width: 100vw;
      min-height: 0;
      background: var(--bg-light);
      box-sizing: border-box;
      overflow-x: hidden;
      position: relative;
      padding-bottom: var(--nav-height);
      transition: padding-bottom var(--transition);
    }
    .page {
      display: none;
      min-width: 0;
      width: 100vw;
      min-height: 70vh;
      box-sizing: border-box;
    }
    .page.active { display: block; }
    .section {
      background: var(--card-bg);
      margin: 24px 12px 24px 12px;
      border-radius: var(--radius);
      padding: 24px 18px;
      box-sizing: border-box;
      box-shadow: var(--shadow);
      margin-bottom: 2vh;
    }
    .loader {
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: #0002;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      color: var(--main-color);
      font-weight: 600;
    }
    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
    nav {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: var(--nav-height);
      background: #fff;
      border-top: 2px solid #b2fff0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
      box-shadow: 0 -4px 10px #0002;
    }
    nav button {
      background: none;
      border: none;
      outline: none;
      padding: 0;
      margin: 0 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--main-color);
      font-size: 0.85em;
      font-weight: 600;
      transition: color var(--transition);
      border-radius: 8px;
      min-width: 48px;
    }
    nav button.active,
    nav button:focus-visible {
      color: var(--text-dark);
      background: var(--accent-color);
    }
    nav .nav-icon {
      width: 32px;
      height: 32px;
      margin-bottom: 2px;
      display: block;
      object-fit: contain;
      background: transparent;
      border-radius: 5px;
    }
    /* –ö–∞—Ä—Ç–æ—á–∫–∏, –∫–Ω–æ–ø–∫–∏ */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 14px;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 18px;
      transition: background .15s;
    }
    .card .emoji {
      font-size: 2em;
      margin-right: 8px;
    }
    .card .desc {
      flex: 1;
      font-size: 1em;
    }
    .paw-action-btn {
      background: var(--main-color);
      color: var(--text-dark);
      border: none;
      border-radius: 10px;
      font-size: 1.08em;
      padding: 8px 18px;
      margin: 8px 0;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background .18s;
    }
    .paw-action-btn:hover { background: #57e1c0; }
    .wide-btn { width: 100%; justify-content: center; }
    /* –ú–æ–¥–∞–ª–∫–∏ */
    .modal-bg {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: #0005;
      z-index: 1100;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 350px;
      width: 90vw;
      padding: 20px;
      position: relative;
    }
    .modal-close {
      position: absolute;
      right: 12px; top: 12px;
      background: none;
      border: none;
      font-size: 1.3em;
      cursor: pointer;
      color: var(--main-color);
      z-index: 2;
    }
    .modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }
    .modal-header img { background: #eafff8; }
    .input-group label {
      display: block;
      margin-bottom: 12px;
      font-size: 1em;
    }
    .input-group span {
      display: block;
      margin-bottom: 2px;
      font-size: 0.98em;
      color: var(--main-color);
      font-weight: 600;
    }
    .input-group input {
      width: 100%;
      padding: 8px 8px;
      border: 1.5px solid var(--main-color);
      border-radius: 8px;
      font-size: 1em;
      margin-bottom: 2px;
      outline: none;
      margin-top: 2px;
      background: #f9fffd;
      transition: border var(--transition);
    }
    .input-group input:focus { border-color: #025a4a; }
    /* –¢–∞–±–ª–∏—Ü—ã, —Å–ø–∏—Å–∫–∏, –º–µ–ª–æ—á–∏ */
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.99em;
    }
    .table th, .table td {
      border: 1px solid #d7f4ec;
      padding: 7px 4px;
      text-align: left;
    }
    .flex-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .icon-btn {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      color: var(--main-color);
      border-radius: 6px;
      transition: background .18s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px; height: 32px;
    }
    .icon-btn:hover, .icon-btn:focus-visible { background: #eafff8; }
    /* Media */
    @media (max-width: 600px) {
      .section, .card { padding: 14px 6vw; }
      header { padding: 8px 4vw; }
      nav { font-size: 0.91em; }
      .logo-img, .icon-size, nav .nav-icon { width: 32px; height: 32px; }
      .modal { max-width: 98vw; }
    }
  </style>
</head>
<body>
  <div class="loader" id="loader" style="display:none">Loading...</div>
  <header>
    <span class="logo-wrap">
      <img src="image1" alt="–õ–æ–≥–æ—Ç–∏–ø" class="logo-img" />
    </span>
    <span id="paw-balance" style="display:none;">
      <span class="paw-balance-text">üêæ <span id="paw-balance-val">0</span></span>
    </span>
    <span id="user-info">
      <button id="show-login-btn" title="–í–æ–π—Ç–∏" type="button">
        <img src="image2" alt="User" class="icon-size"/>
      </button>
      <span id="user-profile" style="display:none;">
        <span id="user-name"></span>
        <button id="signout-btn" type="button" style="display:none;">
          <img src="image2" alt="–í—ã–π—Ç–∏" class="icon-size"/>
        </button>
      </span>
    </span>
  </header>
  <main>
    <div id="page-main" class="page active"></div>
    <div id="page-shop" class="page"></div>
    <div id="page-tasks" class="page"></div>
    <div id="page-claimed" class="page"></div>
    <div id="page-settings" class="page"></div>
  </main>
  <nav>
    <button id="nav-main" class="active" title="–ì–ª–∞–≤–Ω–∞—è">
      <img src="image3" class="nav-icon" alt="–î–æ–º" /><span>–ì–ª–∞–≤–Ω–∞—è</span>
    </button>
    <button id="nav-shop" title="–ú–∞–≥–∞–∑–∏–Ω">
      <img src="image4" class="nav-icon" alt="–ú–∞–≥–∞–∑–∏–Ω" /><span>–ú–∞–≥–∞–∑–∏–Ω</span>
    </button>
    <button id="nav-tasks" title="–ö–≤–µ—Å—Ç—ã">
      <img src="image5" class="nav-icon" alt="–ö–≤–µ—Å—Ç—ã" /><span>–ö–≤–µ—Å—Ç—ã</span>
    </button>
    <button id="nav-claimed" title="–ù–∞–≥—Ä–∞–¥—ã">
      <img src="image6" class="nav-icon" alt="–ù–∞–≥—Ä–∞–¥—ã" /><span>–ù–∞–≥—Ä–∞–¥—ã</span>
    </button>
    <button id="nav-settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
      <img src="image7" class="nav-icon" alt="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" /><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
    </button>
  </nav>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ª–æ–≥–∏–Ω–∞ -->
  <div id="login-modal-bg" class="modal-bg" style="display:none;">
    <div class="modal card-modal">
      <button class="modal-close" type="button" onclick="closeLoginModal()">
        <!-- SVG –∫—Ä–µ—Å—Ç–∏–∫ –∏–∑ flaticon -->
        <svg width="28" height="28" class="icon-svg icon-size" viewBox="0 0 24 24" fill="none"><path d="M5.5 5.5L18.5 18.5M5.5 18.5L18.5 5.5" stroke="#065f54" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <div class="modal-header">
        <img src="image2" class="icon-size" alt="User"/>
        <h2>–í—Ö–æ–¥</h2>
      </div>
      <div class="input-group">
        <label>
          <span>–õ–æ–≥–∏–Ω</span>
          <input type="text" id="login-username" autocomplete="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
        </label>
        <label>
          <span>–ü–∞—Ä–æ–ª—å</span>
          <input type="password" id="login-password" autocomplete="current-password" placeholder="–ü–∞—Ä–æ–ª—å" />
        </label>
        <button class="paw-action-btn wide-btn" type="button" onclick="doLogin()">
          <img src="image2" class="icon-size" alt="User" style="vertical-align:middle;"/> –í–æ–π—Ç–∏
        </button>
        <div style="text-align:center;margin-top:8px;">
          <span id="login-err" style="color:#c00;font-size:0.97em;"></span>
        </div>
      </div>
    </div>
  </div>
  <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
  <div id="confirm-modal-bg" class="modal-bg" style="display:none;">
    <div class="modal" id="confirm-modal">
      <div id="confirm-modal-content"></div>
      <div style="margin-top:18px;display:flex;gap:10px;justify-content:flex-end;">
        <button class="paw-action-btn" id="confirm-cancel-btn">–û—Ç–º–µ–Ω–∞</button>
        <button class="paw-action-btn" id="confirm-ok-btn">–û–ö</button>
      </div>
    </div>
  </div>
  <div id="toast" style="display:none;position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:1200;background:#fff;padding:12px 26px;border-radius:14px;box-shadow:0 2px 18px #0003;font-size:1.07em;font-weight:600;color:var(--main-color);"></div>
  <!-- SVG-–∏–∫–æ–Ω–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–Ω—ã–µ –≤—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –Ω–∏–∂–µ –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ <svg><use href="#svg-id"/></svg> -->
  <svg style="display:none;">
    <symbol id="icon-edit" viewBox="0 0 24 24"><path d="M4 21h4.586a1 1 0 0 0 .707-.293l10.414-10.414a2 2 0 0 0 0-2.828l-2.172-2.172a2 2 0 0 0-2.828 0L4.293 15.879A1 1 0 0 0 4 16.586V21z" fill="#6fedd1" stroke="#065f54" stroke-width="1.5"/><path d="M15 6l3 3" stroke="#065f54" stroke-width="1.5" stroke-linecap="round"/></symbol>
    <symbol id="icon-delete" viewBox="0 0 24 24"><path d="M6 7h12M10 11v6M14 11v6M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" stroke="#065f54" stroke-width="1.5"/><rect x="6" y="7" width="12" height="13" rx="2" fill="#eafff8" stroke="#6fedd1" stroke-width="1.5"/></symbol>
    <symbol id="icon-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="#065f54" stroke-width="2" stroke-linecap="round"/></symbol>
    <symbol id="icon-check" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke="#065f54" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></symbol>
    <symbol id="icon-reload" viewBox="0 0 24 24"><path d="M4 4v5h5M20 20v-5h-5M10 19a7 7 0 0 1-4-6c0-3.87 3.13-7 7-7 1.61 0 3.09.55 4.28 1.47" stroke="#6fedd1" stroke-width="1.5" fill="none"/></symbol>
    <symbol id="icon-award" viewBox="0 0 24 24"><circle cx="12" cy="8" r="5" fill="#ffe1fa" stroke="#065f54" stroke-width="1.5"/><path d="M7 15v5l5-3 5 3v-5" stroke="#065f54" stroke-width="1.5" fill="#fff4c3"/></symbol>
    <symbol id="icon-arrow-right" viewBox="0 0 24 24"><path d="M5 12h14M13 6l6 6-6 6" stroke="#065f54" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
  </svg>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    // === Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyBDHjCE7CYC_jxL7EPjUApVvrd8avHmcNA",
      authDomain: "talk-to-my-paw.firebaseapp.com",
      projectId: "talk-to-my-paw",
      storageBucket: "talk-to-my-paw.appspot.com",
      messagingSenderId: "1023228484299",
      appId: "1:1023228484299:web:df2f42b4bebff7c82b194e",
      measurementId: "G-X51RCW3ND0"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ==== –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ====
    let currentUser = localStorage.getItem('pawCurrentUser') || "";
    let groupId = "demo-family";
    let allData = {
      users: {},
      quests: [],
      completed: [],
      rewards: [],
      claimed: [],
      points: {}
    };
    let isInitialSync = true;
    let currentPage = "main";
    let isAdmin = false;

    // ==== Firestore ====
    async function syncToFirebase() {
      await setDoc(doc(db, "groups", groupId), allData);
    }
    function listenFromFirebase() {
      onSnapshot(doc(db, "groups", groupId), (docSnap) => {
        if (docSnap.exists()) {
          const prevUser = currentUser;
          Object.assign(allData, docSnap.data());
          isInitialSync = false;
          if (prevUser && allData.users[prevUser]) {
            currentUser = prevUser;
            localStorage.setItem('pawCurrentUser', currentUser);
          }
          renderAll();
        }
      });
    }
    async function checkAndAddDemoData() {
      const docSnap = await getDoc(doc(db, "groups", groupId));
      if (!docSnap.exists()) {
        addDemoData();
        await syncToFirebase();
      }
    }
    listenFromFirebase();
    checkAndAddDemoData();

    // ==== –î–µ–º–æ–¥–∞–Ω–Ω—ã–µ ====
    function addDemoData() {
      allData.quests = [
        { type: 'daily', name: '–ü–æ–∫–æ—Ä–º–∏—Ç—å –∫–æ—Ç–∞', emoji: 'üßë‚Äçüç≥', desc: '–î–∞—Ç—å –∑–∞–≤—Ç—Ä–∞–∫ –∫–æ—Ç—É', pts: 3 },
        { type: 'daily', name: '–£—Ç—Ä–µ–Ω–Ω—è—è –ø—Ä–æ–≥—É–ª–∫–∞', emoji: 'üö∂‚Äç‚ôÇÔ∏è', desc: '10 –º–∏–Ω—É—Ç –≤ –ø–∞—Ä–∫–µ', pts: 2 },
        { type: 'weekly', name: '–£–±—Ä–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É', emoji: 'üßπ', desc: '–ù–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ —Å—É–±–±–æ—Ç—É', pts: 5 },
        { type: 'weekly', name: '–ü–æ–∑–≤–æ–Ω–∏—Ç—å –±–∞–±—É—à–∫–µ', emoji: '‚òéÔ∏è', desc: '–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –±–∞–±—É—à–∫–æ–π', pts: 4 },
        { type: 'event', name: '–°—é—Ä–ø—Ä–∏–∑ –Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è', emoji: 'üéâ', desc: '–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å —Å—é—Ä–ø—Ä–∏–∑', pts: 10 }
      ];
      allData.completed = [
        { username: "demo", type: 'daily', name: '–ü–æ—á–∏—Å—Ç–∏—Ç—å –∑—É–±—ã', emoji: 'ü¶∑', desc: '–£—Ç—Ä–æ–º –∏ –≤–µ—á–µ—Ä–æ–º', pts: 1, completedAt: new Date(Date.now() - 86400000).toISOString() }
      ];
      allData.rewards = [
        { name: '–®–æ–∫–æ–ª–∞–¥–∫–∞', emoji: 'üç´', desc: '–°–ª–∞–¥–∫–æ–µ —É–≥–æ—â–µ–Ω–∏–µ', cost: 6 },
        { name: '–ü–ª—é—à–∫–∞', emoji: 'üç©', desc: '–ë—É–ª–æ—á–∫–∞ –∫ —á–∞—é', cost: 4 },
        { name: '–ú—É–ª—å—Ç–∏–∫', emoji: 'üì∫', desc: '30 –º–∏–Ω—É—Ç –º—É–ª—å—Ç–∏–∫–æ–≤', cost: 7 }
      ];
      allData.users = { demo: { name: "–î–µ–º–æ" } };
      allData.points = { demo: 10 };
      allData.claimed = [];
    }

    // ==== –†–µ–Ω–¥–µ—Ä –∏ —Ä–æ—É—Ç–∏–Ω–≥ ====
    const pageIds = ["main", "shop", "tasks", "claimed", "settings"];
    function renderAll() {
      renderHeader();
      renderMain();
      renderShop();
      renderTasks();
      renderClaimed();
      renderSettings();
      highlightNav();
    }
    function renderHeader() {
      // –ë–∞–ª–∞–Ω—Å
      const bal = allData.points[currentUser] || 0;
      document.getElementById("paw-balance-val").textContent = bal;
      document.getElementById("paw-balance").style.display = currentUser ? "" : "none";
      // –ü—Ä–æ—Ñ–∏–ª—å
      const userProfile = document.getElementById("user-profile");
      if (currentUser) {
        document.getElementById("show-login-btn").style.display = "none";
        userProfile.style.display = "flex";
        document.getElementById("user-name").textContent = allData.users[currentUser]?.name || currentUser;
        document.getElementById("signout-btn").style.display = "";
      } else {
        document.getElementById("show-login-btn").style.display = "";
        userProfile.style.display = "none";
      }
    }
    function renderMain() {
      const el = document.getElementById("page-main");
      el.innerHTML = `
        <div class="section">
          <div style="display:flex;align-items:center;gap:10px; margin-bottom:12px;">
            <img src="image1" alt="–ª–æ–≥–æ—Ç–∏–ø" class="logo-img" style="width:48px;height:48px;">
            <span style="font-size:1.25em;font-weight:600;">Talk to my paw</span>
          </div>
          <div style="margin-top:12px;font-size:1.1em;">
            ${currentUser 
              ? `–ü—Ä–∏–≤–µ—Ç, <b>${allData.users[currentUser]?.name || currentUser}</b>!<br>
                  –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ üêæ: <b>${allData.points[currentUser] ?? 0}</b>`
              : `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–µ–º–µ–π–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä –∑–∞–¥–∞–Ω–∏–π, –∫–≤–µ—Å—Ç–æ–≤ –∏ –Ω–∞–≥—Ä–∞–¥!<br>
                <span style="font-size:0.96em;color:#088c6e;">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å üêæ –∏ –ø–æ–ª—É—á–∞—Ç—å –ø—Ä–∏–∑—ã!</span>`}
          </div>
        </div>
        ${currentUser ? `
        <div class="section" style="text-align:center;">
          <div style="margin-bottom:14px;"><b>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</b></div>
          <button class="paw-action-btn" onclick="showPage('tasks')"><svg width="24" height="24"><use href="#icon-plus"/></svg> –ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</button>
          <button class="paw-action-btn" onclick="showPage('shop')"><svg width="24" height="24"><use href="#icon-award"/></svg> –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É</button>
        </div>
        ` : ''}
      `;
    }
    function renderShop() {
      const el = document.getElementById("page-shop");
      let html = `<div class="section"><b>–ú–∞–≥–∞–∑–∏–Ω –Ω–∞–≥—Ä–∞–¥</b></div>`;
      html += allData.rewards.length
        ? allData.rewards.map((rw, i) => `
            <div class="card">
              <span class="emoji">${rw.emoji}</span>
              <span class="desc"><b>${rw.name}</b><br><span style="font-size:0.97em;">${rw.desc}</span></span>
              <span style="min-width:60px;text-align:right;"><svg width="20" height="20"><use href="#icon-award"/></svg> ${rw.cost}</span>
              ${currentUser ? `<button class="paw-action-btn" style="padding:6px 12px;" onclick="claimReward(${i})">–í–∑—è—Ç—å</button>` : ""}
            </div>
          `).join("")
        : `<div class="section">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∞–≥—Ä–∞–¥.</div>`;
      el.innerHTML = html;
    }
    function renderTasks() {
      const el = document.getElementById("page-tasks");
      let html = `<div class="section"><b>–ö–≤–µ—Å—Ç—ã –∏ –∑–∞–¥–∞–Ω–∏—è</b></div>`;
      if (!allData.quests.length) {
        html += `<div class="section">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π.</div>`;
      } else {
        html += allData.quests.map((q, idx) => `
          <div class="card">
            <span class="emoji">${q.emoji}</span>
            <span class="desc"><b>${q.name}</b><br><span style="font-size:0.97em;">${q.desc}</span></span>
            <span style="min-width:50px;"><svg width="20" height="20"><use href="#icon-award"/></svg> ${q.pts}</span>
            ${currentUser ? `<button class="paw-action-btn" style="padding:6px 12px;" onclick="completeQuest(${idx})">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>` : ""}
          </div>
        `).join("");
      }
      el.innerHTML = html;
    }
    function renderClaimed() {
      const el = document.getElementById("page-claimed");
      let html = `<div class="section"><b>–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã</b></div>`;
      const claimed = allData.claimed.filter(x => x.username === currentUser);
      if (!claimed.length) {
        html += `<div class="section">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥.</div>`;
      } else {
        html += claimed.slice().reverse().map(c => `
          <div class="card">
            <span class="emoji">${c.emoji}</span>
            <span class="desc"><b>${c.name}</b><br><span style="font-size:0.97em;">${c.desc}</span></span>
            <span style="min-width:60px;text-align:right;">${new Date(c.claimedAt).toLocaleDateString()}</span>
          </div>
        `).join("");
      }
      el.innerHTML = html;
    }
    function renderSettings() {
      const el = document.getElementById("page-settings");
      let html = `<div class="section"><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</b></div>`;
      if (currentUser) html += `
        <div class="section">
          <div><b>–í–∞—à –ª–æ–≥–∏–Ω:</b> ${currentUser}</div>
          <button class="paw-action-btn" onclick="signOut()"><svg width="24" height="24"><use href="#icon-reload"/></svg> –í—ã–π—Ç–∏</button>
        </div>`;
      else html += `<div class="section">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.</div>`;
      // –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–ø–µ—Ä–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
      if (currentUser === "demo") html += `
        <div class="section">
          <b>–ê–¥–º–∏–Ω-—Ä–∞–∑–¥–µ–ª</b><br>
          <button class="paw-action-btn" onclick="resetDemoData()">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
        </div>
      `;
      el.innerHTML = html;
    }
    function highlightNav() {
      pageIds.forEach(id => {
        document.getElementById("page-" + id).classList.toggle("active", id === currentPage);
        document.getElementById("nav-" + id).classList.toggle("active", id === currentPage);
      });
    }
    function showPage(id) {
      currentPage = id;
      highlightNav();
      renderAll();
      window.scrollTo(0, 0);
    }
    window.showPage = showPage; // –¥–ª—è inline onclick

    // ==== –ù–∞–≤–∏–≥–∞—Ü–∏—è ====
    pageIds.forEach(id => {
      document.getElementById("nav-" + id).addEventListener("click", () => showPage(id));
    });

    // ==== –ö–≤–µ—Å—Ç—ã –∏ –Ω–∞–≥—Ä–∞–¥—ã ====
    window.completeQuest = function(idx) {
      if (!currentUser) return showLoginModal();
      const quest = allData.quests[idx];
      if (!quest) return;
      // –î–æ–±–∞–≤–∏—Ç—å –≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
      allData.completed.push({
        username: currentUser,
        ...quest,
        completedAt: new Date().toISOString()
      });
      // –ë–∞–ª–ª—ã
      allData.points[currentUser] = (allData.points[currentUser] || 0) + quest.pts;
      showToast("–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! +üêæ" + quest.pts);
      syncToFirebase();
    }
    window.claimReward = function(idx) {
      if (!currentUser) return showLoginModal();
      const rw = allData.rewards[idx];
      if (!rw) return;
      const pts = allData.points[currentUser] || 0;
      if (pts < rw.cost) return showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ üêæ!");
      // –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã, –¥–æ–±–∞–≤–∏—Ç—å –≤ claimed
      allData.points[currentUser] -= rw.cost;
      allData.claimed.push({
        username: currentUser,
        ...rw,
        claimedAt: new Date().toISOString()
      });
      showToast("–ü–æ–ª—É—á–µ–Ω–∞ –Ω–∞–≥—Ä–∞–¥–∞: " + rw.name);
      syncToFirebase();
    }
    // ==== –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ====
    function showLoginModal() {
      document.getElementById("login-modal-bg").style.display = "";
      document.getElementById("login-err").textContent = "";
      document.getElementById("login-username").value = "";
      document.getElementById("login-password").value = "";
      setTimeout(() => document.getElementById("login-username").focus(), 100);
    }
    function closeLoginModal() {
      document.getElementById("login-modal-bg").style.display = "none";
    }
    window.closeLoginModal = closeLoginModal;
    window.doLogin = function() {
      const username = document.getElementById("login-username").value.trim();
      const password = document.getElementById("login-password").value;
      if (username.length < 2) {
        document.getElementById("login-err").textContent = "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
        return;
      }
      // Simple local password check (for demo only)
      if (username === "demo" && password !== "demo") {
        document.getElementById("login-err").textContent = "–ü–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–Ω—ã–π";
        return;
      }
      // –ï—Å–ª–∏ –Ω–æ–≤–æ–≥–æ –Ω–µ—Ç - —Å–æ–∑–¥–∞—ë–º
      if (!allData.users[username]) {
        allData.users[username] = { name: username };
        allData.points[username] = 0;
      }
      currentUser = username;
      localStorage.setItem('pawCurrentUser', currentUser);
      closeLoginModal();
      showToast("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!");
      syncToFirebase();
    }
    window.signOut = function() {
      currentUser = "";
      localStorage.removeItem('pawCurrentUser');
      showToast("–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω");
      renderAll();
    }
    document.getElementById("show-login-btn").onclick = showLoginModal;
    document.getElementById("signout-btn").onclick = signOut;

    // ==== –°–±—Ä–æ—Å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö (–¥–ª—è admin/demo) ====
    window.resetDemoData = async function() {
      if (currentUser !== "demo") return;
      addDemoData();
      await syncToFirebase();
      showToast("–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã!");
    }

    // ==== –ú–æ–¥–∞–ª–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, —Ç–æ—Å—Ç—ã ====
    function showToast(text, ms=2200) {
      const toast = document.getElementById("toast");
      toast.textContent = text;
      toast.style.display = "";
      setTimeout(() => { toast.style.display = "none"; }, ms);
    }

    // ==== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====
    renderAll();

    // ==== –ö–ª–∞–≤–∏—à–∏ esc –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–æ–∫ ====
    window.addEventListener('keydown', e => {
      if (e.key === "Escape") {
        closeLoginModal();
        document.getElementById("confirm-modal-bg").style.display = "none";
      }
    });
  </script>
</body>
</html>
